// screw the system
var ideaLogoDataURL = 'data:image/png;base64,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';

/****************************************************
 * This file should load BEFORE main.js, since main.js calls the onReady, onContainer and onViewer methods
 * Note:  This implmentation has been provided for convenience, developers are not required to use this pattern.
 *
 * SEE: Tile API & Development FAQ - https://community.jivesoftware.com/docs/DOC-185776
 ****************************************************/

function fieldsPlaceholder(appLang) {

    console.log("called");

    if ($('#text-box-search').val().length > 0) {
        $('input[name="idea_title"]').val($('#text-box-search').val());
    } else {
        $('input[name="idea_title"]').attr('placeholder', appLang.getKey('idea_title_placeholder'));
    }

    $('textarea[name="idea_content"]').attr('placeholder', appLang.getKey('form_idea_content'));
}

//************************************************************************
//NOTE: CALLED AS SOON AS THE FULL CONTEXT IS RESOLVED
//************************************************************************
function onReady(tileConfig, tileOptions, viewer, container, appLang) {
    // Browse the content of the current page; FIXME: This probably doesn't work if the host of the iframe is not the same as the one outside it.
    var content_url;
    var api_url;
    try {
        content_url = tileConfig.url || window.parent.location.href.split('/').slice(0, 6).concat('content').join('/');
        api_url = window.location.origin + '/api/core/v3';
    } catch (e) {}

    var placeID = ''
    var appAPI = '';
    var categoryFilterFlag = false;
    var categoriesFilter;
    var appLang = new Lang(viewer.jive.locale);
    console.log(tileConfig.isThereFilters);
    // if(tileConfig.isThereFilters){
    //
    // } else {
    // }

    //check if category filter is defined
    if (tileConfig.isThereFilters){
      $('#text-box-search_label').html(appLang.getKey('search_for_ideas_label'));
      $('#text-box-search').attr('placeholder', appLang.getKey('search_for_ideas'));

        if (tileConfig.filters !== undefined && tileConfig.filters.length > 0) {
            var searchBar = $('.ideas-search-bar');
            var selectContainer = $('<div/>', {
              class: 'ideas-search__select-container'
            });
            var selectLabel = $('<label/>', {class: 'ideas-search__label', id: 'search_form_select_label'})
            var select = $('<select>', {
                class: 'ideas-search__select',
                id: 'search_form_select'
            }).change(function (e) {
                if (this.value !== ''){
                    // window.parent.location.href = content_url + "&filterID=contentstatus&published&tag=" + this.value.replace(' ', '+') + ",")
                    var base_url = encodeURI(content_url);
                    var filter = "/content?filterID=contentstatus%5Bpublished%5D~objecttype~objecttype%5Bidea%5D&filterID=contentstatus%5Bpublished%5D~tag";
                    var tags = encodeURIComponent('['+this.value+']').replace('%20', '+');

                    window.parent.location.href = base_url + filter + tags;
                }
            });

            select.append($('<option></option>').val('').html(appLang.getKey('view_ideas_filter')))
            categoryFilterFlag = true;

            tileConfig.filters.forEach(function (field) {
                $('#submit_an_idea').hide();

                select.append($('<option></option>').val(field).html(field));
                selectLabel.html(appLang.getKey('search_for_ideas_category_label'))
                selectContainer.append(selectLabel).append(select);
                searchBar.append(selectContainer);
                //add select field
                $('.ideas-search-bar__input-container').css( "width", "45%" );
            })
        }
    } else {
        $($('.ideas-search-bar')[0]).css('height', '3em');
      $('#submit_an_idea').show();
      $('#text-box-search_label').empty();
      $('#text-box-search').attr('placeholder', appLang.getKey('check_ideas'))
    }


    //find specified url id
    if (tileConfig.url !== undefined) {

        
        if(tileConfig.url.length === 0){
            alert('NO URL SPECIFIED');
            return;
        }
    

        var appUrl = jive.tile.getJiveURL ? jive.tile.getJiveURL() : 'https://' + window.location.host;

        appAPI = new API(api_url, tileConfig.place_id, app.container.id);

        console.log(appAPI);
    }else{
        var appUrl = jive.tile.getJiveURL ? jive.tile.getJiveURL() : 'https://' + window.location.host;

        appAPI = new API(appUrl, app.container.placeID, app.container.id);
        
    }



    $("#config_string").text(tileConfig["configString"]);

    // var appAPI = new API(app.options.gadgetUrls.jiveUrl, app.container.placeID, app.container.id);

    var appUrl = jive.tile.getJiveURL ? jive.tile.getJiveURL() : 'https://' + window.location.host;

    var tileURL = jive.tile.getAppURL ? jive.tile.getAppURL() : '';


    var absoluteURL = tileURL ? "https://" + tileURL.split('/').slice(2, tileURL.split('/').length - 1).join('/') : '';

    function resizeIframe() {
        gadgets.window.adjustHeight();
    }

    $("#create-idea-modal").hide();
    // $('#text-box-search_label').html(appLang.getKey('search_for_ideas_label'));
    // $('#text-box-search').attr('placeholder', appLang.getKey('search_for_ideas'))
    $('#submit_an_idea').html(appLang.getKey('submit_an_idea'));

    $('#btn_submit').html(appLang.getKey('submit_an_idea'));
    $('#btn__modal_cancel').html(appLang.getKey('form_cancel_btn'));

    $('#idea_title').html(appLang.getKey('title_label'));
    $('#description_title').html(appLang.getKey('description_title'));

    $('#modalClose').html(appLang.getKey('modal_close_btn'));


    $('#search_results').html(appLang.getKey('search_results'));
    $('#attachment_label').html(appLang.getKey('form_attachment'));


    //$('#attachment_info').html(appLang.getKey('form_attachement_info'));
    var attachment_info_bloc = $('#attachment_info');
    $('<p>').append(appLang.getKey('form_attachment_info_header')).appendTo(attachment_info_bloc);
    $('<p>').append(appLang.getKey('form_attachment_info_1')).appendTo(attachment_info_bloc);
    $('<p>').append(appLang.getKey('form_attachment_info_2')).appendTo(attachment_info_bloc);
    attachment_info_bloc.hide();

    $('#message_title').html(appLang.getKey('confirmation'));
    $('#message_content').html(appLang.getKey('idea_created'));


    //define event for attachment info
    $('#attach_file').on("click", function() {
        if ($(this).prop('checked') === false) {
            $('#attachment_info').hide();
        } else {
            $('#attachment_info').show();
        }
    });

    //define idea list items selector
    var selector = $('#idea-list');
    var ideasContainer = $("#ideasContainer");
    var debounceTimeout;

    $('#text-box-search').on('input', function(e) {
        var query = content_url + "/content?query=" + $('#text-box-search').val();

        var filter = '';
        if (categoryFilterFlag === true) {
            filter = $('#search_form_select').find(':selected').text();
        }

        var $self = $(this);
        if (debounceTimeout) clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(function() {
            // empty list at each search
            $('#idea-list').empty();
            $('#show-more-ideas').remove();

            if ($self.val().length >= 3) {
                Promise.all([
                    appAPI.search($self.val(), filter)
                ]).then(function(results) {
                    if (results[0].length > 0) {
                        results[0].forEach(function(idea) {
                            //console.log(idea);
                            setTimeout(resizeIframe, 200);
                            var idea_id = idea.id;

                            $('.idea-item-no-result').hide();
                            $('#ideasContainer').addClass('is-active');
                            $('#idea-list').show();
                            $('#search_results').show().html('<i class="fa fa-search" aria-hidden="true"></i>&nbsp;' + appLang.getKey('search_results'));
                            $('<a>', {
                                    class: 'idea-item',
                                    //target: '_blank',
                                    href: appUrl + "/ideas/" + idea_id
                                })
                                // A remplacer par l'url de prod
                                .append($('<img>', { src: absoluteURL ? absoluteURL + '/ideas-logo.png' : ideaLogoDataURL, class: 'idea-item-icon' }))
                                .append($('<div>', { class: 'idea-item-title' }).append(idea.title))
                                //.append($('<div>', { class: 'idea-item-infos' }).append(Utils.formatDate(idea.date, appLang.getKey('monthNames')) + ' - ' + idea.author))
                                .append($('<span>', { class: 'idea-item-tags' }).append(idea.tags))
                                .click(function(e) {
                                    //   console.log(idea_id);
                                    e.preventDefault();
                                    //  var url = appUrl + "/ideas/" + idea_id;
                                    top.window.location.href = this.href;
                                })
                                .appendTo(selector);
                        });
                    } else {
                        $('#idea-list').empty();
                        $('#search_results').hide().empty();
                        $('#ideasContainer').removeClass('is-active');
                        $('<div>', { class: 'idea-item-no-result' })
                            .append(appLang.getKey('no_results'))
                            .appendTo(selector);
                        $('.idea-item-no-result').html(appLang.getKey('no_results'));
                    }

                    if (content_url) {
                        $('<a href="#" id="show-more-ideas" target="_blank" class="link__show-more"></a>').appendTo($('#ideasContainer__wrapper'));
                        $('#show-more-ideas')
                            .append(appLang.getKey('browse_more_ideas'))
                            .attr('href', query);
                    }

                }).catch(function(err) {
                    console.error(err);
                });
            }
        }, 400);
    });

    var height = $('.modal-container').height();

    // Submit an idea
    $("#submit_an_idea").click(function(e) {
        e.preventDefault();
        $("#modal").addClass('is-show');
        $("#ideasContainer").height((height + 100) + "px");
        resizeIframe();

        fieldsPlaceholder(appLang);

    });

    $(".close-modal").click(function(e) {
        e.preventDefault();
        $("#modal").removeClass('is-show');
        $("#ideasContainer").height("auto");
        resizeIframe();
    })

    $("#btn__modal_cancel").click(function(e) {
        e.preventDefault();
        $("#create-idea-modal").addClass('is-hidden');

        //reset fields
        $('form').find("input[type=text], textarea").val("");

        // hide modal
        $("#modal").removeClass('is-show');
        $("#ideasContainer").height("auto");
        resizeIframe();

        fieldsPlaceholder(appLang);
    });

    $('input').attr({
        'autocorrect': 'on',
        'spellcheck': 'true'
    });
    // Check input tel validi
    $('input[type=tel]').attr('minlength', '6');
    // Check if email is valide
    $('input[type=email]').attr('pattern', '[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,3}$');


    // Empêche la soumission du formulaire via le bouton enter
    $("input").keypress(function(evt) {
        var keycode = evt.charCode || evt.keyCode;
        if (keycode == 13) { //Enter key's keycode
            return false;
        }
    });


    //Add an idea
    $('form').submit(function(e) {

        var tagInput = $('form select').first().val();

        var meta = {};
        var extProps = {};
        var data;
        var message = $("#idea-message");
        var modal = $("#create-idea-modal");
        var modalContainer = $(".modal-container");
        var edit_mode = $('#attach_file').prop('checked');
        modalContainer.hide();

        var fieldCount = 0;
        $('#optional_fields').children('div').each(function(i, field) {
            fieldCount++;
            if ($(field).children('select').length > 0) {
                data = $(field).children('select').find(':selected').text();
            } else {
                data = $(field).children('input').val();
            }

            var field_label = $(field).children('label').text();

            //add object to object
            extProps['field_' + fieldCount] = data;
            meta[field_label] = data;

        });

        appAPI.createIdea({
            subject: $('input[name="idea_title"]').val(),
            content: $('textarea').val(),
            tags: tagInput || '',
            meta: meta,
            extProps: extProps
        }).then(function(idea_id) {
            message.addClass("is-show");
            $('input[name="idea_title"]').empty();
            setTimeout(function() {
                window.top.location.href = appUrl + "/ideas/" + idea_id + (edit_mode === true ? "/edit" : "");
            }, 3500);
        }).catch(function(error) {
            $("#message-error").html(error).addClass("is-show");
            setTimeout(function() {
                $("#message-error").removeClass("is-show");
            }, 3000);
        });

        //reset fields
        $('form').find("input[type=text], textarea").val("");

        fieldsPlaceholder(appLang);




    });

    //app.resize();
} // end function

//************************************************************************
//NOTE: CALLED AS SOON AS THE CONFIG IS RESOLVED
//************************************************************************
function onConfig(tileConfig, tileOptions) {
    // console.log('onConfig', tileConfig, tileOptions);

    //display title
    $('#config_string').html(tileConfig.title);

    //show text fields
    var field_required;

    var form = $('#optional_fields');
    if (tileConfig.fields) {
        if (tileConfig.fields.length > 0) {
            tileConfig.fields.forEach(function(field) {
                console.log('field',field);
                field_required = field.required === true ? '*' : '';

                var form_group = $('<div>', { class: 'form-group' });

                form_group.append(
                    $('<label>', {
                        class: 'form-group__label',
                        text: field.label + field_required
                    })
                );

                if (field.type === 'select') {
                    form_group.addClass('form-group__select')
                    var select = $('<select>', {
                        class: 'form-group__input'
                    });

                    field.fields.forEach(function(option) {
                        $('<option>', {
                            value: option.option_value,
                            text: option.option_label
                        }).appendTo(select);
                    });

                    select.appendTo(form_group);

                } else {
                    //text field
                    form_group.append(
                        $('<input>', {
                            class: 'form-group__input',
                            type: field.type,
                            placeholder : field.placeholder
                        }).prop('required', field.required)
                    );
                }

                form.append(form_group);
            });
        }
    }


} // end function

//************************************************************************
//NOTE: CALLED AS SOON AS THE CONTAINER IS RESOLVED
//************************************************************************
function onContainer(container) {
    // console.log('onContainer', container);
} // end function

//************************************************************************
//NOTE: CALLED AS SOON AS THE VIEWER IS RESOLVED
//************************************************************************
function onViewer(viewer) {
    // console.log('onViewer', viewer);
} // end function
